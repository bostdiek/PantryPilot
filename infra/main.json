{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "12566531019241437087"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "allowedValues": [
        "dev",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev or prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "uniqueSuffix": {
      "type": "string",
      "defaultValue": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
      "metadata": {
        "description": "Unique suffix for resource naming"
      }
    },
    "dbAdminUsername": {
      "type": "string",
      "defaultValue": "pantrypilot_admin",
      "metadata": {
        "description": "Database admin username"
      }
    },
    "dbAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Database admin password"
      }
    },
    "secretKey": {
      "type": "securestring",
      "metadata": {
        "description": "Application secret key for JWT signing"
      }
    },
    "upstashRedisRestUrl": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Upstash Redis REST URL for rate limiting (optional)"
      }
    },
    "upstashRedisRestToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Upstash Redis REST Token for rate limiting (optional)"
      }
    },
    "useQuickstartImage": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Use Microsoft quickstart placeholder image for initial deployment (before CI/CD pushes real image)"
      }
    }
  },
  "variables": {
    "environmentSettings": {
      "dev": {
        "acrSku": "Basic",
        "dbSku": "Standard_B1ms",
        "dbStorageSize": 32,
        "containerMinReplicas": 0,
        "containerMaxReplicas": 5,
        "containerCpu": "0.25",
        "containerMemory": "0.5Gi",
        "staticWebAppSku": "Free",
        "keyVaultSku": "standard"
      },
      "prod": {
        "acrSku": "Standard",
        "dbSku": "Standard_B1ms",
        "dbStorageSize": 128,
        "containerMinReplicas": 1,
        "containerMaxReplicas": 3,
        "containerCpu": "0.25",
        "containerMemory": "0.5Gi",
        "staticWebAppSku": "Free",
        "keyVaultSku": "standard"
      }
    },
    "currentSettings": "[variables('environmentSettings')[parameters('environmentName')]]",
    "resourceNames": {
      "acr": "[format('pantrypilotacr{0}{1}', parameters('environmentName'), parameters('uniqueSuffix'))]",
      "keyVault": "[format('ppkv{0}{1}', parameters('environmentName'), parameters('uniqueSuffix'))]",
      "postgreSQL": "[format('pantrypilot-db-{0}-{1}', parameters('environmentName'), parameters('uniqueSuffix'))]",
      "containerAppsEnv": "[format('pantrypilot-env-{0}-{1}', parameters('environmentName'), parameters('uniqueSuffix'))]",
      "containerAppBackend": "[format('pantrypilot-backend-{0}', parameters('environmentName'))]",
      "staticWebApp": "[format('pantrypilot-frontend-{0}-{1}', parameters('environmentName'), parameters('uniqueSuffix'))]",
      "emailService": "[format('pantrypilot-email-{0}-{1}', parameters('environmentName'), parameters('uniqueSuffix'))]",
      "communicationService": "[format('pantrypilot-acs-{0}-{1}', parameters('environmentName'), parameters('uniqueSuffix'))]"
    },
    "commonTags": {
      "Environment": "[parameters('environmentName')]",
      "Project": "PantryPilot",
      "ManagedBy": "Bicep",
      "CostCenter": "Development"
    },
    "useCustomDomain": true,
    "useFrontendCustomDomains": true,
    "frontendCustomDomains": [
      "https://smartmealplanner.app",
      "https://www.smartmealplanner.app"
    ]
  },
  "resources": {
    "acrResource": {
      "existing": true,
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-07-01",
      "name": "[variables('resourceNames').acr]"
    },
    "communicationServiceResource": {
      "existing": true,
      "type": "Microsoft.Communication/communicationServices",
      "apiVersion": "2023-04-01",
      "name": "[variables('resourceNames').communicationService]",
      "dependsOn": [
        "communication"
      ]
    },
    "acsConnectionStringSecret": {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('resourceNames').keyVault, 'acsConnectionString')]",
      "properties": {
        "value": "[listKeys('communicationServiceResource', '2023-04-01').primaryConnectionString]",
        "attributes": {
          "enabled": true
        }
      },
      "dependsOn": [
        "communication",
        "keyVault"
      ]
    },
    "keyVaultResource": {
      "existing": true,
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[variables('resourceNames').keyVault]"
    },
    "containerAppsKeyVaultRoleAssignment": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('resourceNames').keyVault)]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('resourceNames').keyVault), variables('resourceNames').containerAppBackend, 'Key Vault Secrets User')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
        "principalId": "[reference('containerApps').outputs.backendPrincipalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "containerApps"
      ]
    },
    "staticWebAppResource": {
      "existing": true,
      "type": "Microsoft.Web/staticSites",
      "apiVersion": "2023-12-01",
      "name": "[variables('resourceNames').staticWebApp]"
    },
    "staticWebAppSettings": {
      "type": "Microsoft.Web/staticSites/config",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}', variables('resourceNames').staticWebApp, 'appsettings')]",
      "properties": {
        "VITE_API_URL": "[reference('containerApps').outputs.backendUrl.value]",
        "NODE_ENV": "[if(equals(parameters('environmentName'), 'prod'), 'production', 'development')]",
        "VITE_APP_NAME": "PantryPilot",
        "VITE_APP_VERSION": "1.0.0",
        "VITE_API_TIMEOUT": "30000"
      },
      "dependsOn": [
        "containerApps"
      ]
    },
    "acr": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('acr-{0}', uniqueString('acr', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('resourceNames').acr]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[variables('currentSettings').acrSku]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5698041530831965559"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Azure Container Registry"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the ACR will be deployed"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "The SKU of the ACR (Basic, Standard, Premium)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to be applied to the resource"
              }
            },
            "adminUserEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable admin user for simplified authentication with GitHub Actions"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "adminUserEnabled": "[parameters('adminUserEnabled')]",
                "publicNetworkAccess": "Enabled",
                "networkRuleBypassOptions": "AzureServices"
              }
            }
          ],
          "outputs": {
            "loginServer": {
              "type": "string",
              "metadata": {
                "description": "The login server for the Azure Container Registry"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01').loginServer]"
            },
            "id": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Azure Container Registry"
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Azure Container Registry"
              },
              "value": "[parameters('name')]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the ACR for role assignments"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01', 'full').identity.principalId]"
            }
          }
        }
      }
    },
    "keyVault": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('keyVault-{0}', uniqueString('keyVault', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('resourceNames').keyVault]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[variables('currentSettings').keyVaultSku]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          },
          "secrets": {
            "value": {
              "dbAdminPassword": "[parameters('dbAdminPassword')]",
              "secretKey": "[parameters('secretKey')]",
              "dbConnectionString": "[format('postgresql://{0}:{1}@{2}:5432/pantrypilot?sslmode=require', parameters('dbAdminUsername'), parameters('dbAdminPassword'), reference('postgresql').outputs.fqdn.value)]",
              "upstashRedisRestUrl": "[parameters('upstashRedisRestUrl')]",
              "upstashRedisRestToken": "[parameters('upstashRedisRestToken')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17385601775979774577"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the Key Vault will be deployed"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "standard",
              "allowedValues": [
                "standard",
                "premium"
              ],
              "metadata": {
                "description": "The SKU of the Key Vault"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to be applied to the resource"
              }
            },
            "secrets": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Secrets to store in the Key Vault"
              }
            },
            "enableRbacAuthorization": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable RBAC authorization for Key Vault access"
              }
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable soft delete for Key Vault"
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "metadata": {
                "description": "Soft delete retention days"
              }
            },
            "principalIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Principal IDs that need access to the Key Vault secrets"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "[parameters('sku')]"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": "[parameters('enableRbacAuthorization')]",
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "enablePurgeProtection": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                },
                "accessPolicies": "[if(parameters('enableRbacAuthorization'), createArray(), createArray(createObject('tenantId', subscription().tenantId, 'objectId', '', 'permissions', createObject('secrets', createArray('get', 'list', 'set', 'delete')))))]"
              }
            },
            {
              "copy": {
                "name": "keyVaultSecretsUserRoleAssignment",
                "count": "[length(parameters('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('name'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('name')), parameters('principalIds')[copyIndex()], 'Key Vault Secrets User')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
                "principalId": "[parameters('principalIds')[copyIndex()]]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
              ]
            },
            {
              "copy": {
                "name": "secretResources",
                "count": "[length(items(parameters('secrets')))]"
              },
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('name'), items(parameters('secrets'))[copyIndex()].key)]",
              "properties": {
                "value": "[items(parameters('secrets'))[copyIndex()].value]",
                "attributes": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault"
              },
              "value": "[parameters('name')]"
            },
            "id": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Key Vault"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
            },
            "vaultUri": {
              "type": "string",
              "metadata": {
                "description": "The URI of the Key Vault"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '2023-07-01').vaultUri]"
            },
            "secretReferences": {
              "type": "object",
              "metadata": {
                "description": "Secret references for Container Apps environment variables"
              },
              "value": {
                "databasePassword": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=database-password)', parameters('name'))]",
                "jwtSecretKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=jwt-secret-key)', parameters('name'))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "postgresql"
      ]
    },
    "postgresql": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('postgresql-{0}', uniqueString('postgresql', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('resourceNames').postgreSQL]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "administratorLogin": {
            "value": "[parameters('dbAdminUsername')]"
          },
          "administratorPassword": {
            "value": "[parameters('dbAdminPassword')]"
          },
          "skuName": {
            "value": "[variables('currentSettings').dbSku]"
          },
          "storageSizeGB": {
            "value": "[variables('currentSettings').dbStorageSize]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10511028375301306376"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the PostgreSQL Flexible Server"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the PostgreSQL server will be deployed"
              }
            },
            "administratorLogin": {
              "type": "string",
              "metadata": {
                "description": "The administrator login name for the server"
              }
            },
            "administratorPassword": {
              "type": "securestring",
              "metadata": {
                "description": "The administrator password for the server"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard_B1ms",
              "metadata": {
                "description": "The SKU name for the server (e.g., Standard_B1ms, Standard_B2s)"
              }
            },
            "storageSizeGB": {
              "type": "int",
              "defaultValue": 32,
              "metadata": {
                "description": "The storage size in GB"
              }
            },
            "version": {
              "type": "string",
              "defaultValue": "15",
              "metadata": {
                "description": "The PostgreSQL version"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to be applied to the resource"
              }
            },
            "backupRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "minValue": 7,
              "maxValue": 35,
              "metadata": {
                "description": "Backup retention days (7-35)"
              }
            },
            "geoRedundantBackup": {
              "type": "string",
              "defaultValue": "Disabled",
              "metadata": {
                "description": "Enable geo-redundant backup"
              }
            },
            "highAvailability": {
              "type": "string",
              "defaultValue": "Disabled",
              "metadata": {
                "description": "Enable high availability"
              }
            },
            "allowedIpRanges": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "List of allowed IP ranges for firewall rules"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2023-06-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[if(startsWith(parameters('skuName'), 'Standard_B'), 'Burstable', if(startsWith(parameters('skuName'), 'Standard_D'), 'GeneralPurpose', 'MemoryOptimized'))]"
              },
              "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorPassword')]",
                "version": "[parameters('version')]",
                "storage": {
                  "storageSizeGB": "[parameters('storageSizeGB')]"
                },
                "backup": {
                  "backupRetentionDays": "[parameters('backupRetentionDays')]",
                  "geoRedundantBackup": "[parameters('geoRedundantBackup')]"
                },
                "highAvailability": {
                  "mode": "[parameters('highAvailability')]"
                },
                "network": {
                  "delegatedSubnetResourceId": null,
                  "privateDnsZoneArmResourceId": null
                },
                "authConfig": {
                  "activeDirectoryAuth": "Disabled",
                  "passwordAuth": "Enabled",
                  "tenantId": "[subscription().tenantId]"
                }
              }
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
              "apiVersion": "2023-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'pantrypilot')]",
              "properties": {
                "charset": "UTF8",
                "collation": "en_US.UTF8"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
              "apiVersion": "2023-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'AllowAzureServices')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('name'))]"
              ]
            },
            {
              "copy": {
                "name": "additionalFirewallRules",
                "count": "[length(parameters('allowedIpRanges'))]"
              },
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
              "apiVersion": "2023-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), format('AllowedRange{0}', copyIndex()))]",
              "properties": {
                "startIpAddress": "[parameters('allowedIpRanges')[copyIndex()].startIp]",
                "endIpAddress": "[parameters('allowedIpRanges')[copyIndex()].endIp]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "The fully qualified domain name of the PostgreSQL server"
              },
              "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('name')), '2023-06-01-preview').fullyQualifiedDomainName]"
            },
            "id": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the PostgreSQL server"
              },
              "value": "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the PostgreSQL server"
              },
              "value": "[parameters('name')]"
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "The name of the PostgreSQL database"
              },
              "value": "pantrypilot"
            }
          }
        }
      }
    },
    "communication": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('communication-{0}', uniqueString('communication', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "emailServiceName": {
            "value": "[variables('resourceNames').emailService]"
          },
          "communicationServiceName": {
            "value": "[variables('resourceNames').communicationService]"
          },
          "location": {
            "value": "global"
          },
          "dataLocation": {
            "value": "United States"
          },
          "domainManagement": "[if(and(equals(parameters('environmentName'), 'prod'), variables('useCustomDomain')), createObject('value', 'CustomerManaged'), createObject('value', 'AzureManaged'))]",
          "customDomainName": "[if(and(equals(parameters('environmentName'), 'prod'), variables('useCustomDomain')), createObject('value', 'mail.smartmealplanner.app'), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3442256222270193083"
            },
            "name": "Azure Communication Services",
            "description": "Deploys Azure Communication Services and Email Services for transactional email support."
          },
          "parameters": {
            "emailServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Email Service resource."
              }
            },
            "communicationServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Communication Service resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "global",
              "metadata": {
                "description": "The geo-location where the resource lives. ACS resources use global location."
              }
            },
            "dataLocation": {
              "type": "string",
              "defaultValue": "United States",
              "allowedValues": [
                "United States",
                "Europe",
                "UK",
                "Australia",
                "Japan",
                "France",
                "Switzerland"
              ],
              "metadata": {
                "description": "The location where the service stores its data at rest."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags."
              }
            },
            "domainManagement": {
              "type": "string",
              "defaultValue": "AzureManaged",
              "allowedValues": [
                "AzureManaged",
                "CustomerManaged"
              ],
              "metadata": {
                "description": "Whether to use Azure Managed Domain (for dev) or Customer Managed Domain (for prod)."
              }
            },
            "customDomainName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Custom domain name (required if domainManagement is CustomerManaged)."
              }
            },
            "userEngagementTracking": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable user engagement tracking for emails."
              }
            }
          },
          "resources": {
            "emailService": {
              "type": "Microsoft.Communication/emailServices",
              "apiVersion": "2023-04-01",
              "name": "[parameters('emailServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]"
              }
            },
            "azureManagedDomain": {
              "condition": "[equals(parameters('domainManagement'), 'AzureManaged')]",
              "type": "Microsoft.Communication/emailServices/domains",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', parameters('emailServiceName'), 'AzureManagedDomain')]",
              "location": "[parameters('location')]",
              "properties": {
                "domainManagement": "AzureManaged",
                "userEngagementTracking": "[if(parameters('userEngagementTracking'), 'Enabled', 'Disabled')]"
              },
              "dependsOn": [
                "emailService"
              ]
            },
            "customerManagedDomain": {
              "condition": "[and(equals(parameters('domainManagement'), 'CustomerManaged'), not(empty(parameters('customDomainName'))))]",
              "existing": true,
              "type": "Microsoft.Communication/emailServices/domains",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', parameters('emailServiceName'), parameters('customDomainName'))]",
              "dependsOn": [
                "emailService"
              ]
            },
            "communicationService": {
              "type": "Microsoft.Communication/communicationServices",
              "apiVersion": "2023-04-01",
              "name": "[parameters('communicationServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]",
                "linkedDomains": [
                  "[if(equals(parameters('domainManagement'), 'AzureManaged'), resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), 'AzureManagedDomain'), resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), parameters('customDomainName')))]"
                ]
              },
              "dependsOn": [
                "azureManagedDomain",
                "emailService"
              ]
            }
          },
          "outputs": {
            "emailServiceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Email Service."
              },
              "value": "[resourceId('Microsoft.Communication/emailServices', parameters('emailServiceName'))]"
            },
            "emailServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Email Service."
              },
              "value": "[parameters('emailServiceName')]"
            },
            "communicationServiceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Communication Service."
              },
              "value": "[resourceId('Microsoft.Communication/communicationServices', parameters('communicationServiceName'))]"
            },
            "communicationServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Communication Service."
              },
              "value": "[parameters('communicationServiceName')]"
            },
            "emailDomainId": {
              "type": "string",
              "metadata": {
                "description": "The email domain resource ID."
              },
              "value": "[if(equals(parameters('domainManagement'), 'AzureManaged'), resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), 'AzureManagedDomain'), resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), parameters('customDomainName')))]"
            },
            "fromSenderDomain": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "The sender domain (from address) for emails."
              },
              "value": "[if(equals(parameters('domainManagement'), 'AzureManaged'), tryGet(if(equals(parameters('domainManagement'), 'AzureManaged'), reference('azureManagedDomain', '2023-04-01', 'full'), null()), 'properties', 'fromSenderDomain'), tryGet(if(and(equals(parameters('domainManagement'), 'CustomerManaged'), not(empty(parameters('customDomainName')))), reference('customerManagedDomain', '2023-04-01', 'full'), null()), 'properties', 'fromSenderDomain'))]"
            },
            "mailFromSenderDomain": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "The mail-from sender domain for the email envelope."
              },
              "value": "[if(equals(parameters('domainManagement'), 'AzureManaged'), tryGet(if(equals(parameters('domainManagement'), 'AzureManaged'), reference('azureManagedDomain', '2023-04-01', 'full'), null()), 'properties', 'mailFromSenderDomain'), tryGet(if(and(equals(parameters('domainManagement'), 'CustomerManaged'), not(empty(parameters('customDomainName')))), reference('customerManagedDomain', '2023-04-01', 'full'), null()), 'properties', 'mailFromSenderDomain'))]"
            },
            "verificationRecords": {
              "type": "object",
              "metadata": {
                "description": "DNS verification records for Customer Managed Domain (empty for Azure Managed). Handle securely."
              },
              "value": "[if(and(equals(parameters('domainManagement'), 'CustomerManaged'), not(empty(parameters('customDomainName')))), coalesce(tryGet(tryGet(if(and(equals(parameters('domainManagement'), 'CustomerManaged'), not(empty(parameters('customDomainName')))), reference('customerManagedDomain', '2023-04-01', 'full'), null()), 'properties'), 'verificationRecords'), createObject()), createObject())]"
            }
          }
        }
      }
    },
    "staticWebApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('staticWebApp-{0}', uniqueString('staticWebApp', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('resourceNames').staticWebApp]"
          },
          "location": {
            "value": "West US 2"
          },
          "sku": {
            "value": "[variables('currentSettings').staticWebAppSku]"
          },
          "repositoryUrl": {
            "value": "https://github.com/bostdiek/PantryPilot"
          },
          "branch": "[if(equals(parameters('environmentName'), 'prod'), createObject('value', 'production'), createObject('value', 'main'))]",
          "appLocation": {
            "value": "/apps/frontend"
          },
          "buildLocation": {
            "value": "/dist"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6749503126676904848"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Static Web App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "West US 2",
              "metadata": {
                "description": "The location where the Static Web App will be deployed"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Free",
              "allowedValues": [
                "Free",
                "Standard"
              ],
              "metadata": {
                "description": "The SKU of the Static Web App (Free or Standard)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to be applied to the resource"
              }
            },
            "repositoryUrl": {
              "type": "string",
              "metadata": {
                "description": "The GitHub repository URL"
              }
            },
            "branch": {
              "type": "string",
              "defaultValue": "main",
              "metadata": {
                "description": "The branch to deploy from"
              }
            },
            "appLocation": {
              "type": "string",
              "defaultValue": "/apps/frontend",
              "metadata": {
                "description": "The location of the app source code"
              }
            },
            "buildLocation": {
              "type": "string",
              "defaultValue": "/dist",
              "metadata": {
                "description": "The location of the build output"
              }
            },
            "backendApiUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The backend API URL to connect to (optional, can be set after Container Apps deploys)"
              }
            },
            "allowConfigFileUpdates": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable staging environments for pull requests"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "[parameters('sku')]"
              },
              "properties": {
                "buildProperties": {
                  "appLocation": "[parameters('appLocation')]",
                  "apiLocation": "",
                  "outputLocation": "[parameters('buildLocation')]",
                  "skipGithubActionWorkflowGeneration": true
                },
                "repositoryUrl": "[parameters('repositoryUrl')]",
                "branch": "[parameters('branch')]",
                "allowConfigFileUpdates": "[parameters('allowConfigFileUpdates')]",
                "stagingEnvironmentPolicy": "Enabled",
                "enterpriseGradeCdnStatus": "Disabled"
              }
            },
            {
              "condition": "[not(empty(parameters('backendApiUrl')))]",
              "type": "Microsoft.Web/staticSites/config",
              "apiVersion": "2023-12-01",
              "name": "[format('{0}/{1}', parameters('name'), 'appsettings')]",
              "properties": {
                "VITE_API_URL": "[parameters('backendApiUrl')]",
                "NODE_ENV": "[if(contains(parameters('name'), 'prod'), 'production', 'development')]",
                "VITE_APP_NAME": "PantryPilot",
                "VITE_APP_VERSION": "1.0.0",
                "VITE_API_TIMEOUT": "30000"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "The default hostname of the Static Web App"
              },
              "value": "[reference(resourceId('Microsoft.Web/staticSites', parameters('name')), '2023-12-01').defaultHostname]"
            },
            "id": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Static Web App"
              },
              "value": "[resourceId('Microsoft.Web/staticSites', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the Static Web App"
              },
              "value": "[parameters('name')]"
            },
            "url": {
              "type": "string",
              "metadata": {
                "description": "The URL of the Static Web App"
              },
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/staticSites', parameters('name')), '2023-12-01').defaultHostname)]"
            }
          }
        }
      }
    },
    "containerApps": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('containerApps-{0}', uniqueString('containerApps', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environmentName": {
            "value": "[variables('resourceNames').containerAppsEnv]"
          },
          "backendAppName": {
            "value": "[variables('resourceNames').containerAppBackend]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "containerImage": "[if(parameters('useQuickstartImage'), createObject('value', 'mcr.microsoft.com/k8se/quickstart:latest'), createObject('value', format('{0}/pantrypilot-backend:latest', reference('acr').outputs.loginServer.value)))]",
          "minReplicas": {
            "value": "[variables('currentSettings').containerMinReplicas]"
          },
          "maxReplicas": {
            "value": "[variables('currentSettings').containerMaxReplicas]"
          },
          "containerCpu": {
            "value": "[variables('currentSettings').containerCpu]"
          },
          "containerMemory": {
            "value": "[variables('currentSettings').containerMemory]"
          },
          "keyVaultUri": {
            "value": "[reference('keyVault').outputs.vaultUri.value]"
          },
          "upstashRedisRestUrl": {
            "value": "[parameters('upstashRedisRestUrl')]"
          },
          "upstashRedisRestToken": {
            "value": "[parameters('upstashRedisRestToken')]"
          },
          "registryServer": "[if(parameters('useQuickstartImage'), createObject('value', ''), createObject('value', reference('acr').outputs.loginServer.value))]",
          "registryUsername": "[if(parameters('useQuickstartImage'), createObject('value', ''), createObject('value', listCredentials('acrResource', '2023-07-01').username))]",
          "registryPassword": "[if(parameters('useQuickstartImage'), createObject('value', ''), createObject('value', listCredentials('acrResource', '2023-07-01').passwords[0].value))]",
          "corsOrigins": {
            "value": "[concat(createArray(format('https://{0}', reference('staticWebApp').outputs.defaultHostname.value)), if(equals(parameters('environmentName'), 'prod'), if(variables('useFrontendCustomDomains'), variables('frontendCustomDomains'), createArray()), createArray('http://localhost:5173', 'http://127.0.0.1:5173')))]"
          },
          "emailSenderAddress": "[if(not(equals(tryGet(tryGet(reference('communication').outputs, 'fromSenderDomain'), 'value'), null())), createObject('value', format('DoNotReply@{0}', tryGet(tryGet(reference('communication').outputs, 'fromSenderDomain'), 'value'))), createObject('value', ''))]",
          "frontendUrl": "[if(and(equals(parameters('environmentName'), 'prod'), variables('useFrontendCustomDomains')), createObject('value', 'https://smartmealplanner.app'), createObject('value', format('https://{0}', reference('staticWebApp').outputs.defaultHostname.value)))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8377512633349252080"
            }
          },
          "parameters": {
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Apps environment"
              }
            },
            "backendAppName": {
              "type": "string",
              "metadata": {
                "description": "The name of the backend Container App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the Container Apps will be deployed"
              }
            },
            "containerImage": {
              "type": "string",
              "metadata": {
                "description": "The container image for the backend app"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "containerCpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "vCPU allocation for the container (e.g., 0.25, 0.5, 1)"
              }
            },
            "containerMemory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation for the container (e.g., 0.5Gi, 1Gi)"
              }
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "The URI of the Key Vault containing secrets"
              }
            },
            "registryServer": {
              "type": "string",
              "metadata": {
                "description": "The container registry server"
              }
            },
            "registryUsername": {
              "type": "string",
              "metadata": {
                "description": "The container registry username"
              }
            },
            "registryPassword": {
              "type": "securestring",
              "metadata": {
                "description": "The container registry password"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to be applied to the resources"
              }
            },
            "corsOrigins": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed CORS origins for the backend API"
              }
            },
            "upstashRedisRestUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Upstash Redis REST URL for rate limiting (optional)"
              }
            },
            "upstashRedisRestToken": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Upstash Redis REST Token for rate limiting (optional)"
              }
            },
            "emailSenderAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Email sender address for Azure Communication Services (e.g., DoNotReply@domain.com)"
              }
            },
            "frontendUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Frontend URL for email links (password reset, verification). Include https:// protocol."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2025-07-01",
              "name": "[format('{0}-logs', parameters('environmentName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-10-02-preview",
              "name": "[parameters('environmentName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "workloadProfiles": [
                  {
                    "workloadProfileType": "Consumption",
                    "name": "Consumption"
                  }
                ],
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('environmentName'))), '2025-07-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('environmentName'))), '2025-07-01').primarySharedKey]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('environmentName')))]"
              ]
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-10-02-preview",
              "name": "[parameters('backendAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "environmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 8000,
                    "transport": "auto",
                    "allowInsecure": false,
                    "corsPolicy": {
                      "allowCredentials": true,
                      "allowedOrigins": "[if(empty(parameters('corsOrigins')), createArray('*'), parameters('corsOrigins'))]",
                      "allowedMethods": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "OPTIONS",
                        "PATCH"
                      ],
                      "allowedHeaders": [
                        "*"
                      ]
                    }
                  },
                  "registries": "[if(empty(parameters('registryServer')), createArray(), createArray(createObject('server', parameters('registryServer'), 'username', parameters('registryUsername'), 'passwordSecretRef', 'acr-password')))]",
                  "secrets": "[concat(if(empty(parameters('registryPassword')), createArray(), createArray(createObject('name', 'acr-password', 'value', parameters('registryPassword')))), concat(createArray(createObject('name', 'database-connection-string', 'keyVaultUrl', format('{0}secrets/dbConnectionString', parameters('keyVaultUri')), 'identity', 'system'), createObject('name', 'secret-key', 'keyVaultUrl', format('{0}secrets/secretKey', parameters('keyVaultUri')), 'identity', 'system'), createObject('name', 'gemini-api-key', 'keyVaultUrl', format('{0}secrets/geminiApiKey', parameters('keyVaultUri')), 'identity', 'system'), createObject('name', 'acs-connection-string', 'keyVaultUrl', format('{0}secrets/acsConnectionString', parameters('keyVaultUri')), 'identity', 'system')), if(or(empty(parameters('upstashRedisRestUrl')), empty(parameters('upstashRedisRestToken'))), createArray(), createArray(createObject('name', 'upstash-redis-url', 'value', parameters('upstashRedisRestUrl')), createObject('name', 'upstash-redis-token', 'value', parameters('upstashRedisRestToken'))))))]"
                },
                "template": {
                  "containers": [
                    {
                      "image": "[parameters('containerImage')]",
                      "name": "pantrypilot-backend",
                      "resources": {
                        "cpu": "[json(parameters('containerCpu'))]",
                        "memory": "[parameters('containerMemory')]"
                      },
                      "env": "[concat(createArray(createObject('name', 'DATABASE_URL', 'secretRef', 'database-connection-string'), createObject('name', 'SECRET_KEY', 'secretRef', 'secret-key'), createObject('name', 'GEMINI_API_KEY', 'secretRef', 'gemini-api-key'), createObject('name', 'ENVIRONMENT', 'value', if(contains(parameters('environmentName'), 'prod'), 'production', 'development')), createObject('name', 'LOG_LEVEL', 'value', 'INFO'), createObject('name', 'API_V1_STR', 'value', '/api/v1'), createObject('name', 'PROJECT_NAME', 'value', 'PantryPilot'), createObject('name', 'VERSION', 'value', '0.1.0'), createObject('name', 'ALGORITHM', 'value', 'HS256'), createObject('name', 'ACCESS_TOKEN_EXPIRE_MINUTES', 'value', '30'), createObject('name', 'PORT', 'value', '8000'), createObject('name', 'PYTHONPATH', 'value', '/app/src'), createObject('name', 'CORS_ORIGINS', 'value', join(parameters('corsOrigins'), ',')), createObject('name', 'AZURE_COMMUNICATION_CONNECTION_STRING', 'secretRef', 'acs-connection-string'), createObject('name', 'EMAIL_SENDER_ADDRESS', 'value', parameters('emailSenderAddress')), createObject('name', 'FRONTEND_URL', 'value', parameters('frontendUrl'))), if(or(empty(parameters('upstashRedisRestUrl')), empty(parameters('upstashRedisRestToken'))), createArray(), createArray(createObject('name', 'UPSTASH_REDIS_REST_URL', 'secretRef', 'upstash-redis-url'), createObject('name', 'UPSTASH_REDIS_REST_TOKEN', 'secretRef', 'upstash-redis-token'))))]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/api/v1/health",
                            "port": 8000,
                            "scheme": "HTTP"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "timeoutSeconds": 5,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/api/v1/health",
                            "port": 8000,
                            "scheme": "HTTP"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "timeoutSeconds": 3,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling-rule",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "20"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
              ]
            }
          ],
          "outputs": {
            "backendUrl": {
              "type": "string",
              "metadata": {
                "description": "The fully qualified domain name of the backend app"
              },
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', parameters('backendAppName')), '2024-10-02-preview').configuration.ingress.fqdn)]"
            },
            "backendAppId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the backend Container App"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('backendAppName'))]"
            },
            "backendPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The system-assigned principal ID of the backend app"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('backendAppName')), '2024-10-02-preview', 'full').identity.principalId]"
            },
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Apps environment"
              },
              "value": "[parameters('environmentName')]"
            },
            "environmentId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Container Apps environment"
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "acr",
        "acsConnectionStringSecret",
        "communication",
        "keyVault",
        "staticWebApp"
      ]
    }
  },
  "outputs": {
    "acrLoginServer": {
      "type": "string",
      "value": "[reference('acr').outputs.loginServer.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference('keyVault').outputs.name.value]"
    },
    "databaseFqdn": {
      "type": "string",
      "value": "[reference('postgresql').outputs.fqdn.value]"
    },
    "backendUrl": {
      "type": "string",
      "value": "[reference('containerApps').outputs.backendUrl.value]"
    },
    "staticWebAppUrl": {
      "type": "string",
      "value": "[reference('staticWebApp').outputs.defaultHostname.value]"
    },
    "staticWebAppName": {
      "type": "string",
      "value": "[reference('staticWebApp').outputs.name.value]"
    },
    "communicationServiceName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Communication Service for backend email integration."
      },
      "value": "[reference('communication').outputs.communicationServiceName.value]"
    },
    "emailServiceName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Email Service (for Azure portal reference)."
      },
      "value": "[reference('communication').outputs.emailServiceName.value]"
    },
    "emailFromDomain": {
      "type": "string",
      "nullable": true,
      "value": "[tryGet(tryGet(reference('communication').outputs, 'fromSenderDomain'), 'value')]"
    }
  }
}
