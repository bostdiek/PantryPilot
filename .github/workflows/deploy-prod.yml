# =============================================================================
# Deploy to Production Environment
# =============================================================================
name: Deploy to Prod

on:
  push:
    branches: [production]
    paths:
      - "infra/**"
      - "apps/**"
      - ".github/workflows/deploy-prod.yml"
  workflow_dispatch:
  workflow_run:
    workflows: ["Build Container Images"]
    types: [completed]
    branches: [production]

concurrency:
  group: deploy-prod
  cancel-in-progress: false

env:
  AZURE_RESOURCE_GROUP: rg-pantrypilot-prod
  DEPLOY_ENV: prod

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    environment: prod # Requires approval in GitHub environment settings
    permissions:
      contents: read
      id-token: write

    outputs:
      acr-login-server: ${{ steps.deploy.outputs.acrLoginServer }}
      backend-url: ${{ steps.deploy.outputs.backendUrl }}
      static-web-app-url: ${{ steps.deploy.outputs.staticWebAppUrl }}
      key-vault-name: ${{ steps.deploy.outputs.keyVaultName }}
      static-web-app-name: ${{ steps.deploy.outputs.staticWebAppName }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create resource group if not exists
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location "Central US" \
            --tags environment=prod project=pantrypilot

      - name: Deploy Bicep infrastructure
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ./infra/main.bicep
          parameters: ./infra/parameters/main.prod.bicepparam
          deploymentName: pantrypilot-prod-${{ github.run_number }}
          failOnStdErr: false
        env:
          AZURE_LOCATION: "Central US"
          AZURE_UNIQUE_SUFFIX: prod001
          DB_ADMIN_PASSWORD: ${{ secrets.DB_ADMIN_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          BRAVE_SEARCH_API_KEY: ${{ secrets.BRAVE_SEARCH_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Output deployment info
        run: |
          echo "## Prod Infrastructure Deployed â˜ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "**ACR:** ${{ steps.deploy.outputs.acrLoginServer }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend URL:** ${{ steps.deploy.outputs.backendUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** https://${{ steps.deploy.outputs.staticWebAppUrl }}" >> $GITHUB_STEP_SUMMARY

  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: prod
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"

      - name: Install dependencies
        working-directory: apps/backend
        run: uv sync --frozen

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get database connection string from Key Vault
        id: secrets
        run: |
          DB_CONNECTION=$(az keyvault secret show \
            --vault-name "${{ needs.deploy-infrastructure.outputs.key-vault-name }}" \
            --name dbConnectionString \
            --query value -o tsv)
          echo "::add-mask::$DB_CONNECTION"
          echo "DATABASE_URL=$DB_CONNECTION" >> $GITHUB_ENV

      - name: Run Alembic migrations
        working-directory: apps/backend
        run: |
          uv run alembic -c src/alembic.ini upgrade head
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Output migration status
        run: |
          echo "## Database Migrations Complete âœ…" >> $GITHUB_STEP_SUMMARY

  update-container-app:
    name: Update Container App
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, run-migrations]
    environment: prod
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Container App with latest image
        run: |
          az containerapp update \
            --name pantrypilot-backend-prod \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ needs.deploy-infrastructure.outputs.acr-login-server }}/pantrypilot-backend:prod

      - name: Verify deployment health
        run: |
          sleep 30
          BACKEND_URL="${{ needs.deploy-infrastructure.outputs.backend-url }}"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/api/v1/health" || echo "000")
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… Health check passed (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ Health check returned HTTP $HTTP_STATUS - please verify manually"
            exit 1
          fi

      - name: Output deployment summary
        run: |
          echo "## Production Deployment Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:** ${{ needs.deploy-infrastructure.outputs.backend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend:** https://${{ needs.deploy-infrastructure.outputs.static-web-app-url }}" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend to SWA
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, update-container-app]
    environment: prod
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24.1.0"
          cache: "npm"
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        working-directory: apps/frontend
        run: npm ci

      - name: Build frontend
        working-directory: apps/frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ needs.deploy-infrastructure.outputs.backend-url }}

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get SWA deployment token
        id: swa-token
        run: |
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name "${{ needs.deploy-infrastructure.outputs.static-web-app-name }}" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.apiKey" -o tsv)
          echo "::add-mask::$SWA_TOKEN"
          echo "token=$SWA_TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "apps/frontend/dist"
          skip_app_build: true
          skip_api_build: true
